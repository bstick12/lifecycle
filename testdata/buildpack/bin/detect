#!/bin/bash

set -euo pipefail

platform_dir=$1
plan_path=$2

echo "detect out: ${BP_ID}@${BP_VERSION}"
>&2 echo "detect err: ${BP_ID}@${BP_VERSION}"

echo "Path: ${BP_PATH}" > "detect-info-${BP_ID}-${BP_VERSION}"
echo "TOML: ${BP_TOML}" >> "detect-info-${BP_ID}-${BP_VERSION}"

ls -1 "$platform_dir/env" > "detect-env-${BP_ID}-${BP_VERSION}"

if [[ -f detect-plan-${BP_ID}-${BP_VERSION}.toml ]]; then
  cat "detect-plan-${BP_ID}-${BP_VERSION}.toml" > "$plan_path"
fi

if [[ -f detect-status-${BP_ID}-${BP_VERSION} ]]; then
  exit "$(cat "detect-status-${BP_ID}-${BP_VERSION}")"
fi
if [[ -f detect-status ]]; then
  exit "$(cat detect-status)"
fi

exit 0