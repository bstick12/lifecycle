#!/bin/bash

set -euo pipefail

layers_dir=$1
platform_dir=$2
plan_path=$3

echo "build out: ${BP_ID}@${BP_VERSION}"
>&2 echo "build err: ${BP_ID}@${BP_VERSION}"

echo "Path: ${BP_PATH}" > "build-info-${BP_ID}-${BP_VERSION}"
echo "TOML: ${BP_TOML}" >> "build-info-${BP_ID}-${BP_VERSION}"

ls -1 "$platform_dir/env" > "build-env-${BP_ID}-${BP_VERSION}"

cat "$plan_path" > "build-plan-${BP_ID}-${BP_VERSION}.toml"

if [[ -f launch-${BP_ID}-${BP_VERSION}.toml ]]; then
  cat "launch-${BP_ID}-${BP_VERSION}.toml" > "$layers_dir/launch.toml"
fi

if [[ -d layers-${BP_ID}-${BP_VERSION} ]]; then
  cp -a "layers-${BP_ID}-${BP_VERSION}/." "$layers_dir"
fi

if [[ -f build-status-${BP_ID}-${BP_VERSION} ]]; then
  exit "$(cat "build-status-${BP_ID}-${BP_VERSION}")"
fi
if [[ -f build-status ]]; then
  exit "$(cat build-status)"
fi

exit 0